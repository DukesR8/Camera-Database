<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dukes R8 Camera Database - Professional Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f172a;
            --bg-light: #f8fafc;
            --border: #e2e8f0;
            --text-dark: #1e293b;
            --text-light: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-light);
            color: var(--text-dark);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .stats-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-add-camera {
            background: white;
            color: var(--primary);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-add-camera:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Location Selector Bar */
        .location-bar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .location-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .location-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
        }

        .location-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-group select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .location-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-filter {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.2rem;
            transition: all 0.2s;
        }

        .btn-filter:hover {
            background: var(--primary-dark);
        }

        .btn-reset {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.2rem;
            transition: all 0.2s;
        }

        .btn-reset:hover {
            background: #475569;
        }

        /* Main Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 450px;
            background: white;
            border-left: 1px solid var(--border);
            overflow-y: auto;
            display: none;
            box-shadow: -4px 0 6px -1px rgba(0, 0, 0, 0.1);
        }

        .sidebar.active {
            display: block;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-light);
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .btn-close:hover {
            color: var(--danger);
        }

        .sidebar-content {
            padding: 1.5rem;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group-inline {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .info-card p {
            font-size: 0.9rem;
            color: #1e40af;
            line-height: 1.6;
        }

        .alert-card {
            background: #fef3c7;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .alert-card p {
            font-size: 0.9rem;
            color: #92400e;
            line-height: 1.6;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex: 1;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        /* Camera Info Display */
        .camera-info {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .camera-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .camera-info-row:last-child {
            border-bottom: none;
        }

        .camera-info-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .camera-info-value {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.95rem;
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 3rem 2rem;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Map Marker Cluster */
        .camera-marker {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s;
        }

        .camera-marker:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .location-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: absolute;
                bottom: 0;
                max-height: 70vh;
                z-index: 999;
            }
        }

        @media (max-width: 768px) {
            .form-group-inline {
                grid-template-columns: 1fr;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-speed {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-redlight {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-both {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-left">
                <h1><i class="fas fa-camera"></i> Dukes R8 Camera Database</h1>
                <p>Professional speed camera database editor and management system</p>
            </div>
            <div class="header-right">
                <div class="stats-badge">
                    <i class="fas fa-database"></i>
                    <span id="totalCameras">Loading...</span>
                </div>
                <button class="btn-add-camera" onclick="showAddCameraForm()">
                    <i class="fas fa-plus-circle"></i>
                    Add New Camera
                </button>
            </div>
        </div>
    </header>

    <div class="location-bar">
        <div class="location-content">
            <div class="location-group" style="flex: 2;">
                <label><i class="fas fa-search"></i> Search Location</label>
                <input type="text" id="searchInput" placeholder="Search by coordinates, description..." 
                       style="padding: 0.75rem 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem;">
            </div>
            <div class="location-group">
                <label><i class="fas fa-camera"></i> Camera Type</label>
                <select id="typeFilter">
                    <option value="">All Types</option>
                    <option value="RED_LIGHT_CAMERA">Red Light</option>
                    <option value="SPEED_CAMERA">Speed Camera</option>
                </select>
            </div>
            <button class="btn-filter" onclick="filterCameras()">
                <i class="fas fa-search"></i> Search
            </button>
            <button class="btn-reset" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
    </div>

    <div class="container">
        <div id="map"></div>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 id="sidebarTitle"><i class="fas fa-camera"></i> Camera Details</h2>
                <button class="btn-close" onclick="closeSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="loading-text">Click a camera on the map to view details</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([39.8283, -98.5795], 4); // Center on USA

        // Add tile layer with professional styling
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        let cameras = [];
        let allCameras = [];
        let markers = [];
        let selectedCamera = null;
        let regions = {};
        let cities = {};

        // Custom camera icon
        const cameraIcon = L.divIcon({
            html: '<div class="camera-marker"><i class="fas fa-camera"></i></div>',
            iconSize: [36, 36],
            className: ''
        });

        // Load camera database
        async function loadCameras() {
            try {
                const response = await fetch('Camera_Database_Bundle_Sorted.json');
                const data = await response.json();
                
                // Extract all cameras
                allCameras = [];
                if (data.feeds) {
                    data.feeds.forEach(feed => {
                        if (feed.staticAlerts) {
                            allCameras = allCameras.concat(feed.staticAlerts);
                        }
                    });
                }

                cameras = [...allCameras];
                processLocationData();
                displayCamerasOnMap();
                updateStats();
            } catch (error) {
                console.error('Error loading cameras:', error);
                alert('Error loading camera database. Please ensure Camera_Database_Bundle_Sorted.json is available.');
            }
        }

        // Filter cameras based on search and type
        async function filterCameras() {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            const typeFilter = document.getElementById('typeFilter').value;

            // If search text looks like a location name (not coordinates), geocode it
            if (searchText && !searchText.match(/^-?\d+\.?\d*,\s*-?\d+\.?\d*$/)) {
                // Reset to all cameras for location search
                cameras = [...allCameras];
                
                // Apply type filter only
                if (typeFilter) {
                    cameras = cameras.filter(camera => camera.type === typeFilter);
                }
                
                await geocodeAndZoom(searchText);
                return; // Exit early - geocode will handle the rest
            }

            // Text/coordinate search
            cameras = allCameras.filter(camera => {
                // Type filter
                if (typeFilter && camera.type !== typeFilter) {
                    return false;
                }

                // Search filter (description, coordinates, id)
                if (searchText) {
                    const description = (camera.description || '').toLowerCase();
                    const id = (camera.id || '').toLowerCase();
                    const coords = `${camera.latitude},${camera.longitude}`.toLowerCase();
                    
                    if (!description.includes(searchText) && 
                        !id.includes(searchText) && 
                        !coords.includes(searchText)) {
                        return false;
                    }
                }

                return true;
            });

            displayCamerasOnMap();

            // Zoom to filtered cameras if any
            if (cameras.length > 0) {
                const bounds = L.latLngBounds(cameras.map(c => [
                    c.latitude,
                    c.longitude
                ]).filter(coords => coords[0] && coords[1]));
                
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        // Geocode location name and zoom to it
        async function geocodeAndZoom(locationName) {
            try {
                // Use OpenStreetMap Nominatim for geocoding (free)
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`
                );
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    // Add a temporary marker
                    if (window.searchMarker) {
                        window.searchMarker.remove();
                    }
                    window.searchMarker = L.marker([lat, lon])
                        .addTo(map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                    
                    // Zoom to the location and wait for moveend event
                    map.once('moveend', () => {
                        // Force camera display after zoom completes
                        displayCamerasOnMap();
                    });
                    
                    map.setView([lat, lon], 11);
                    
                    // Remove marker after 5 seconds
                    setTimeout(() => {
                        if (window.searchMarker) {
                            window.searchMarker.remove();
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                // Silently fail - continue with text search
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('typeFilter').value = '';
            cameras = [...allCameras];
            displayCamerasOnMap();
            map.setView([39.8283, -98.5795], 4);
        }

        // Process location data (simplified - not needed anymore but keeping for compatibility)
        function processLocationData() {
            // No longer needed since we removed region/city filters
        }

        // Display cameras on map with performance optimization
        function displayCamerasOnMap() {
            // Clear existing markers
            markers.forEach(marker => marker.remove());
            markers = [];

            // Get current map bounds
            const bounds = map.getBounds();
            const zoom = map.getZoom();
            
            // Only show cameras within current view and limit based on zoom
            let maxCameras = 1000; // Default limit
            if (zoom < 6) maxCameras = 500;      // Very zoomed out
            else if (zoom < 8) maxCameras = 1000; // Medium zoom
            else if (zoom < 10) maxCameras = 2000; // Closer zoom
            else maxCameras = 5000;               // Very close zoom

            let visibleCameras = 0;
            
            cameras.forEach((camera, index) => {
                const lat = camera.location?.latitude || camera.latitude;
                const lon = camera.location?.longitude || camera.longitude;

                if (lat && lon && visibleCameras < maxCameras) {
                    // Check if camera is within current map bounds
                    if (bounds.contains([lat, lon])) {
                        const marker = L.marker([lat, lon], { icon: cameraIcon })
                            .addTo(map)
                            .on('click', () => showCameraDetails(camera, index));
                        
                        markers.push(marker);
                        visibleCameras++;
                    }
                }
            });

            // Update stats to show visible vs total
            updateStats(visibleCameras);
        }

        // Show camera details
        function showCameraDetails(camera, index) {
            selectedCamera = { ...camera, index };
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('active');

            const lat = camera.latitude || camera.location?.latitude;
            const lon = camera.longitude || camera.location?.longitude;
            const type = camera.type || camera.alertType || 'Unknown';
            
            // Extract speed from description (e.g., "Limit: 50 kmh" or "Limit: 35 mph")
            const speedMatch = camera.description?.match(/Limit:\s*(\d+)\s*(kmh|km\/h|kph|mph)?/i);
            const speed = speedMatch ? speedMatch[1] : '';
            const speedUnit = speedMatch && speedMatch[2] ? speedMatch[2].toLowerCase() : '';
            
            const direction = camera.direction || '';
            const street = camera.street || camera.road || '';
            const city = camera.city || '';
            const state = camera.state || camera.province || '';

            const typeBadge = type === 'speed' ? 'badge-speed' : type === 'red_light' ? 'badge-redlight' : 'badge-both';

            document.getElementById('sidebarTitle').innerHTML = '<i class="fas fa-camera"></i> Camera Details';
            document.getElementById('sidebarContent').innerHTML = `
                <div class="info-card">
                    <p><i class="fas fa-info-circle"></i> Edit camera information below or report an issue. All changes create a GitHub issue for review.</p>
                </div>

                <div class="camera-info">
                    <div class="camera-info-row">
                        <span class="camera-info-label">Type</span>
                        <span class="badge ${typeBadge}">${type.replace('_', ' ').toUpperCase()}</span>
                    </div>
                    ${speed ? `<div class="camera-info-row">
                        <span class="camera-info-label">Speed Limit</span>
                        <span class="camera-info-value">${
                            speedUnit.includes('km') || speedUnit.includes('kph') 
                                ? `${speed} km/h (${Math.round(speed * 0.621371)} mph)`
                                : speedUnit === 'mph'
                                    ? `${speed} mph (${Math.round(speed * 1.60934)} km/h)`
                                    : speed
                        }</span>
                    </div>` : ''}
                    ${direction ? `<div class="camera-info-row">
                        <span class="camera-info-label">Direction</span>
                        <span class="camera-info-value">${direction}°</span>
                    </div>` : ''}
                    <div class="camera-info-row">
                        <span class="camera-info-label">Description</span>
                        <span class="camera-info-value">${camera.description || 'No description'}</span>
                    </div>
                    <div class="camera-info-row">
                        <span class="camera-info-label">Coordinates</span>
                        <span class="camera-info-value">${lat.toFixed(6)}, ${lon.toFixed(6)}</span>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-edit"></i> Edit Camera Information
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Camera Type</label>
                        <select id="cameraType">
                            <option value="speed" ${type === 'speed' ? 'selected' : ''}>Speed Camera</option>
                            <option value="red_light" ${type === 'red_light' ? 'selected' : ''}>Red Light Camera</option>
                            <option value="both" ${type === 'both' ? 'selected' : ''}>Speed + Red Light</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-tachometer-alt"></i> Speed Limit</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                            <input type="number" id="speedLimit" value="${speed}" placeholder="60" oninput="updateSpeedConversionDynamic()">
                            <select id="speedUnit" onchange="updateSpeedConversionDynamic()">
                                <option value="mph" ${speedUnit === 'mph' || !speedUnit ? 'selected' : ''}>mph</option>
                                <option value="kmh" ${speedUnit.includes('km') || speedUnit.includes('kph') ? 'selected' : ''}>km/h</option>
                            </select>
                        </div>
                        <small style="color: var(--text-light); margin-top: 0.25rem; display: block;">
                            <span id="speedLimitConversion">${
                                speed && speedUnit === 'mph' 
                                    ? Math.round(speed * 1.60934) + ' km/h'
                                    : speed && (speedUnit.includes('km') || speedUnit.includes('kph'))
                                        ? Math.round(speed * 0.621371) + ' mph'
                                        : ''
                            }</span>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-compass"></i> Direction (0-360°)</label>
                        <input type="number" id="direction" value="${direction}" placeholder="180" min="0" max="360">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-info-circle"></i> Description</label>
                        <input type="text" id="description" value="${camera.description || ''}" placeholder="Limit: 50 kmh | Monitors: N">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-road"></i> Street Name</label>
                        <input type="text" id="street" value="${street}" placeholder="Main Street">
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label><i class="fas fa-city"></i> City</label>
                            <input type="text" id="cityInput" value="${city}" placeholder="City">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map"></i> State/Province</label>
                            <input type="text" id="stateInput" value="${state}" placeholder="State">
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Latitude</label>
                            <input type="number" step="0.000001" id="latitude" value="${lat}">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Longitude</label>
                            <input type="number" step="0.000001" id="longitude" value="${lon}">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-exclamation-triangle"></i> Report an Issue
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-list"></i> Issue Type</label>
                        <select id="issueType">
                            <option value="">Select issue type...</option>
                            <option value="wrong_location">Wrong Location</option>
                            <option value="wrong_speed">Wrong Speed Limit</option>
                            <option value="wrong_direction">Wrong Direction</option>
                            <option value="camera_removed">Camera Removed</option>
                            <option value="duplicate">Duplicate Entry</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-comment"></i> Description</label>
                        <textarea id="issueDescription" placeholder="Describe the issue or proposed changes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Your Contact (optional)</label>
                        <input type="text" id="reporterContact" placeholder="Name or email for follow-up (optional)">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="submitEdit()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button class="btn btn-danger" onclick="reportIssue()">
                        <i class="fas fa-flag"></i> Report Issue
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="closeSidebar()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;

            // Zoom to camera
            map.setView([lat, lon], 16);
        }

        // Show add camera form
        function showAddCameraForm() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('active');

            document.getElementById('sidebarTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Camera';
            document.getElementById('sidebarContent').innerHTML = `
                <div class="alert-card">
                    <p><i class="fas fa-lightbulb"></i> Click on the map to set the camera location, or enter coordinates manually below.</p>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fas fa-camera"></i> Camera Information
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Camera Type *</label>
                        <select id="newCameraType" required>
                            <option value="">Select type...</option>
                            <option value="speed">Speed Camera</option>
                            <option value="red_light">Red Light Camera</option>
                            <option value="both">Speed + Red Light</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-tachometer-alt"></i> Speed Limit *</label>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                            <input type="number" id="newSpeedLimit" placeholder="60" required oninput="updateNewSpeedConversion()">
                            <select id="newSpeedUnit" onchange="updateNewSpeedConversion()">
                                <option value="mph" selected>mph</option>
                                <option value="kmh">km/h</option>
                            </select>
                        </div>
                        <small style="color: var(--text-light); margin-top: 0.25rem; display: block;">
                            <span id="newSpeedLimitConversion"></span>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-compass"></i> Direction (0-360°)</label>
                        <input type="number" id="newDirection" placeholder="180" min="0" max="360">
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-road"></i> Street Name *</label>
                        <input type="text" id="newStreet" placeholder="Main Street" required>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label><i class="fas fa-city"></i> City *</label>
                            <input type="text" id="newCity" placeholder="City" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map"></i> State/Province *</label>
                            <input type="text" id="newState" placeholder="State" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-flag"></i> Country *</label>
                        <select id="newCountry" required>
                            <option value="">Select country...</option>
                            <option value="USA">United States</option>
                            <option value="Canada">Canada</option>
                        </select>
                    </div>

                    <div class="form-group-inline">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Latitude *</label>
                            <input type="number" step="0.000001" id="newLatitude" placeholder="Click map or enter manually" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Longitude *</label>
                            <input type="number" step="0.000001" id="newLongitude" placeholder="Click map or enter manually" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-comment"></i> Additional Notes</label>
                        <textarea id="newNotes" placeholder="Any additional information about this camera..."></textarea>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Your Contact (optional)</label>
                        <input type="text" id="newSubmitterContact" placeholder="Name or email for follow-up (optional)">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="submitNewCamera()">
                        <i class="fas fa-plus-circle"></i> Add Camera
                    </button>
                    <button class="btn btn-secondary" onclick="closeSidebar()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;

            // Enable map clicking for location
            enableMapClicking();
        }

        // Enable map clicking to set new camera location
        let mapClickHandler = null;
        function enableMapClicking() {
            if (mapClickHandler) {
                map.off('click', mapClickHandler);
            }

            mapClickHandler = function(e) {
                document.getElementById('newLatitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('newLongitude').value = e.latlng.lng.toFixed(6);
                
                // Add temporary marker
                if (window.tempMarker) {
                    window.tempMarker.remove();
                }
                window.tempMarker = L.marker(e.latlng, { icon: cameraIcon }).addTo(map);
            };

            map.on('click', mapClickHandler);
        }

        // Submit new camera
        function submitNewCamera() {
            const type = document.getElementById('newCameraType').value;
            const speed = document.getElementById('newSpeedLimit').value;
            const speedUnit = document.getElementById('newSpeedUnit').value;
            const direction = document.getElementById('newDirection').value || '';
            const street = document.getElementById('newStreet').value;
            const city = document.getElementById('newCity').value;
            const state = document.getElementById('newState').value;
            const country = document.getElementById('newCountry').value;
            const lat = document.getElementById('newLatitude').value;
            const lon = document.getElementById('newLongitude').value;
            const notes = document.getElementById('newNotes').value;
            const contact = document.getElementById('newSubmitterContact').value;

            if (!type || !speed || !street || !city || !state || !country || !lat || !lon) {
                alert('Please fill in all required fields (marked with *)');
                return;
            }

            const title = `[NEW CAMERA] ${street}, ${city}, ${state}`;
            
            // Pass the form data to pre-fill GitHub form (uses new-camera.yml template)
            createGitHubIssue(title, ['new-camera', 'community-submission'], {
                camera_type: type,
                speed_limit: speed,
                speed_unit: speedUnit,
                direction: direction,
                street: street,
                city: city,
                state: state,
                country: country,
                latitude: lat,
                longitude: lon,
                notes: notes,
                contact: contact
            }, 'new-camera.yml');

            // Clean up
            if (window.tempMarker) {
                window.tempMarker.remove();
            }
            if (mapClickHandler) {
                map.off('click', mapClickHandler);
            }
        }

        // Submit camera edit
        function submitEdit() {
            const type = document.getElementById('cameraType').value;
            const speed = document.getElementById('speedLimit').value;
            const speedUnit = document.getElementById('speedUnit').value;
            const direction = document.getElementById('direction').value;
            const street = document.getElementById('street').value;
            const city = document.getElementById('cityInput').value;
            const state = document.getElementById('stateInput').value;
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;

            // Get original values
            const origType = selectedCamera.type || 'N/A';
            const origSpeed = selectedCamera.speed_limit || 'N/A';
            const origDirection = selectedCamera.direction || 'N/A';
            const origStreet = selectedCamera.street || 'N/A';
            const origCity = selectedCamera.city || 'N/A';
            const origState = selectedCamera.state || selectedCamera.province || 'N/A';
            const origLat = selectedCamera.latitude || selectedCamera.location?.latitude || 'N/A';
            const origLon = selectedCamera.longitude || selectedCamera.location?.longitude || 'N/A';

            const title = `[EDIT] ${street}, ${city} - Camera Update`;
            
            // Build detailed comparison of changes
            let changes = [];
            if (type !== origType) changes.push(`Type: ${origType} → ${type}`);
            if (speed !== origSpeed.toString()) changes.push(`Speed Limit: ${origSpeed} km/h → ${speed} km/h`);
            if (direction !== origDirection.toString()) changes.push(`Direction: ${origDirection}° → ${direction}°`);
            if (street !== origStreet) changes.push(`Street: ${origStreet} → ${street}`);
            if (city !== origCity) changes.push(`City: ${origCity} → ${city}`);
            if (state !== origState) changes.push(`State: ${origState} → ${state}`);
            if (lat !== origLat.toString()) changes.push(`Latitude: ${origLat} → ${lat}`);
            if (lon !== origLon.toString()) changes.push(`Longitude: ${origLon} → ${lon}`);

            const changesSummary = changes.length > 0 ? changes.join('\n') : 'No changes detected';
            
            // Create detailed edit description
            const editDescription = `## Camera Edit Request

### Location
**Street:** ${street}  
**City:** ${city}  
**State/Province:** ${state}  
**Coordinates:** ${lat}, ${lon}

### Requested Changes
${changesSummary}

### New Camera Data (Apply these values)
\`\`\`json
{
  "type": "${type}",
  "speed_limit": ${speed},
  "speed_unit": "${speedUnit}",
  "direction": ${direction},
  "street": "${street}",
  "city": "${city}",
  "state": "${state}",
  "latitude": ${lat},
  "longitude": ${lon}
}
\`\`\`

### Original Camera Data (Before Edit)
\`\`\`json
${JSON.stringify(selectedCamera, null, 2)}
\`\`\`

---
**Instructions:** Review the changes above and update the camera database accordingly.`;

            createGitHubIssue(title, ['camera-edit', 'community-submission'], {
                camera_info: editDescription,
                coordinates: `${lat}, ${lon}`,
                issue_type: 'Camera Update',
                correction: changesSummary
            }, 'camera-edit.yml');
        }

        // Report issue
        function reportIssue() {
            const issueType = document.getElementById('issueType').value;
            const description = document.getElementById('issueDescription').value;
            const contact = document.getElementById('reporterContact').value;

            if (!issueType) {
                alert('Please select an issue type');
                return;
            }

            if (!description) {
                alert('Please provide a description');
                return;
            }

            const lat = selectedCamera.location?.latitude || selectedCamera.latitude;
            const lon = selectedCamera.location?.longitude || selectedCamera.longitude;
            const street = selectedCamera.street || 'Unknown';
            const city = selectedCamera.city || 'Unknown';
            const state = selectedCamera.state || selectedCamera.province || 'Unknown';
            const type = selectedCamera.type || 'Unknown';
            const speed = selectedCamera.speed_limit || 'Unknown';
            const direction = selectedCamera.direction || 'Unknown';
            const cameraId = selectedCamera.id || '';

            const title = `[${issueType === 'camera_removed' ? 'REMOVED' : 'ISSUE'}] ${issueType.replace('_', ' ')} - ${street}, ${city}`;

            // Determine which template to use
            const isRemoval = issueType === 'camera_removed';
            const labels = isRemoval ? ['camera-removed', 'community-report'] : ['camera-edit', 'community-report'];
            const template = isRemoval ? 'camera-removed.yml' : 'camera-edit.yml';
            
            if (isRemoval) {
                // Camera removal - use removal-specific format
                createGitHubIssue(title, labels, {
                    camera_id: cameraId,
                    coordinates: `${lat}, ${lon}`,
                    camera_description: `${type.toUpperCase()} camera at ${street}, ${city}, ${state}`,
                    removal_reason: description,
                    details: `Camera ID: ${cameraId}\nType: ${type}\nSpeed: ${speed}\nDirection: ${direction}\nReported by: ${contact || 'Anonymous'}`,
                    contact: contact
                }, template);
            } else {
                // Other issue types - use edit format
                const issueReport = `## Camera Issue Report

### Issue Type
**${issueType.replace('_', ' ').toUpperCase()}**

### Camera Location
**Street:** ${street}  
**City:** ${city}  
**State/Province:** ${state}  
**Coordinates:** ${lat}, ${lon}

### Current Camera Details
**Type:** ${type}  
**Speed Limit:** ${speed} km/h  
**Direction:** ${direction}°

### Issue Description
${description}

${contact ? `### Reporter Contact\n${contact}` : '### Reporter\nAnonymous'}

### Full Camera Data
\`\`\`json
${JSON.stringify(selectedCamera, null, 2)}
\`\`\`

---
**Date:** ${new Date().toISOString()}`;

                createGitHubIssue(title, labels, {
                    camera_info: issueReport,
                    coordinates: `${lat}, ${lon}`,
                    issue_type: issueType.replace('_', ' '),
                    correction: description
                }, template);
            }
        }

        // GitHub Configuration
        const GITHUB_CONFIG = {
            owner: 'DukesR8',           // Your GitHub username
            repo: 'Camera-Database'     // Your repository name
        };

        // Open GitHub issue form (NO LOGIN REQUIRED!)
        // Creates a properly formatted issue that GitHub Actions can parse
        function createGitHubIssue(title, labels, formData = null, template = null) {
            // Validate configuration
            if (GITHUB_CONFIG.owner === 'YOUR_GITHUB_USERNAME' || GITHUB_CONFIG.repo === 'YOUR_REPO_NAME') {
                document.getElementById('sidebarContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem 2rem;">
                        <div style="font-size: 4rem; color: var(--danger); margin-bottom: 1rem;">⚠️</div>
                        <h3 style="color: var(--danger); margin-bottom: 1rem;">Configuration Required</h3>
                        <p style="color: var(--text-dark); margin-bottom: 1rem; line-height: 1.8;">
                            <strong>GitHub integration not configured!</strong>
                        </p>
                        <p style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6; text-align: left;">
                            To enable submissions, edit <code>index.html</code> around line 1218 and update:<br><br>
                            <code style="background: #f1f5f9; padding: 0.5rem; display: block; border-radius: 4px; margin-top: 0.5rem;">
                            const GITHUB_CONFIG = {<br>
                            &nbsp;&nbsp;owner: 'YourGitHubUsername',<br>
                            &nbsp;&nbsp;repo: 'YourRepoName'<br>
                            };
                            </code>
                        </p>
                        <button class="btn btn-secondary" onclick="closeSidebar()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;
                return;
            }

            // Build the issue body with formatted data
            let issueBody = '';
            let issueLabels = labels.join(',');
            
            if (formData && formData.camera_type) {
                // New camera submission - format the data for GitHub Actions to parse
                issueBody = encodeURIComponent(`### Camera Type
${formData.camera_type}

### Speed Limit
${formData.speed_limit} ${formData.speed_unit || 'mph'}

### Direction (0-360°)
${formData.direction || 'Not specified'}

### Street Name
${formData.street}

### City
${formData.city}

### State/Province
${formData.state}

### Country
${formData.country}

### Latitude
${formData.latitude}

### Longitude
${formData.longitude}

### Additional Notes
${formData.notes || 'None'}

### Your Contact (Optional)
${formData.contact || 'Anonymous'}
`);
            } else if (formData && formData.removal_reason) {
                // Camera removal - format for camera-removed.yml template
                issueBody = encodeURIComponent(`### Camera ID (if known)
${formData.camera_id || 'Not available'}

### Coordinates
${formData.coordinates}

### Camera Description
${formData.camera_description}

### Why is this camera no longer valid?
${formData.removal_reason}

### Additional Details
${formData.details || 'None'}
`);
            } else if (formData && formData.camera_info) {
                // Edit or issue report
                issueBody = encodeURIComponent(`### Camera Location/Description
${formData.camera_info}

### Coordinates (if known)
${formData.coordinates || 'Not specified'}

### What needs to be fixed?
${formData.issue_type || 'Other'}

### Proposed Correction / Details
${formData.correction || formData.details || 'See description'}
`);
            }
            
            // Create the GitHub new issue URL with pre-filled title and body
            let githubUrl = `https://github.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/issues/new?title=${encodeURIComponent(title)}&body=${issueBody}&labels=${issueLabels}`;
            
            // Add template parameter if specified (needed for issue templates)
            if (template) {
                githubUrl += `&template=${encodeURIComponent(template)}`;
            }
            
            // Show instructions to user
            const isRemovalRequest = formData && formData.removal_reason;
            const emoji = isRemovalRequest ? '🗑️' : '📋';
            const actionText = isRemovalRequest ? 'Camera Removal Request' : 'GitHub Submission';
            
            document.getElementById('sidebarContent').innerHTML = `
                <div style="text-align: center; padding: 3rem 2rem;">
                    <div style="font-size: 4rem; color: var(--primary); margin-bottom: 1rem;">${emoji}</div>
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Opening ${actionText}</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.8;">
                        <strong>You're being redirected to GitHub</strong><br>
                        All your data is pre-filled!<br><br>
                        Just click "Submit new issue" (no login required!)<br><br>
                        ${isRemovalRequest ? 'The camera will be reviewed and removed from the database.' : 'A Pull Request will be automatically created for review.'}
                    </p>
                    <a href="${githubUrl}" target="_blank" class="btn btn-primary" style="display: inline-flex; text-decoration: none;">
                        <i class="fas fa-external-link-alt"></i> Submit to GitHub
                    </a>
                    <button class="btn btn-secondary" onclick="closeSidebar()" style="margin-top: 1rem;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            
            // Auto-open in 1 second
            setTimeout(() => {
                window.open(githubUrl, '_blank');
            }, 1000);
        }

        // Update stats
        function updateStats(visibleCount = null) {
            if (visibleCount !== null) {
                document.getElementById('totalCameras').textContent = `${visibleCount.toLocaleString()} of ${cameras.length.toLocaleString()} cameras`;
            } else {
                document.getElementById('totalCameras').textContent = `${cameras.length.toLocaleString()} cameras`;
            }
        }

        // Close sidebar
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            if (window.tempMarker) {
                window.tempMarker.remove();
            }
            if (mapClickHandler) {
                map.off('click', mapClickHandler);
            }
        }

        // Update speed conversion for edit form
        function updateSpeedConversionDynamic() {
            const speedInput = document.getElementById('speedLimit');
            const unitSelect = document.getElementById('speedUnit');
            const conversionDisplay = document.getElementById('speedLimitConversion');
            
            if (!speedInput || !unitSelect || !conversionDisplay) return;
            
            const speed = parseFloat(speedInput.value);
            const unit = unitSelect.value;
            
            if (speed && !isNaN(speed)) {
                if (unit === 'mph') {
                    const kmh = Math.round(speed * 1.60934);
                    conversionDisplay.textContent = `≈ ${kmh} km/h`;
                } else { // kmh
                    const mph = Math.round(speed * 0.621371);
                    conversionDisplay.textContent = `≈ ${mph} mph`;
                }
            } else {
                conversionDisplay.textContent = '';
            }
        }
        
        // Update speed conversion for new camera form
        function updateNewSpeedConversion() {
            const speedInput = document.getElementById('newSpeedLimit');
            const unitSelect = document.getElementById('newSpeedUnit');
            const conversionDisplay = document.getElementById('newSpeedLimitConversion');
            
            if (!speedInput || !unitSelect || !conversionDisplay) return;
            
            const speed = parseFloat(speedInput.value);
            const unit = unitSelect.value;
            
            if (speed && !isNaN(speed)) {
                if (unit === 'mph') {
                    const kmh = Math.round(speed * 1.60934);
                    conversionDisplay.textContent = `≈ ${kmh} km/h`;
                } else { // kmh
                    const mph = Math.round(speed * 0.621371);
                    conversionDisplay.textContent = `≈ ${mph} mph`;
                }
            } else {
                conversionDisplay.textContent = '';
            }
        }

        // Add map event listeners for performance
        map.on('moveend', displayCamerasOnMap);
        map.on('zoomend', displayCamerasOnMap);

        // Initialize
        loadCameras();
    </script>
</body>
</html>
